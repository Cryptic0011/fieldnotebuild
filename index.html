<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graysons Tools</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary-color: #93c5fd;
            --background-color: #f1f5f9;
            --card-background: #ffffff;
            --text-color: #1e293b;
            --light-text-color: #64748b;
            --border-color: #cbd5e1;
            --danger-color: #ef4444;
            --danger-dark: #dc2626;
            --font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');

        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 2rem;
        }

        #root {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
            background: var(--card-background);
            border-radius: 8px;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
        }

        .tab-button {
            padding: 1rem 1.5rem;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--text-color);
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            border-radius: 6px;
        }

        .tab-button.active {
            background-color: var(--primary-color);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 2.5rem;
            color: var(--primary-dark);
        }

        h2, h4 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-dark);
            margin-top: 0;
            display: flex;
            align-items: center;
        }
        
        h2 {
             border-bottom: 2px solid var(--border-color);
             padding-bottom: 0.75rem;
        }
        
        h4 {
            color: var(--primary-color);
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--light-text-color);
        }

        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 0.8rem 1rem;
            margin-bottom: 1.25rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-sizing: border-box;
            transition: all 0.3s ease;
            background-color: #fdfdfd;
            font-family: var(--font-family);
            font-size: 1rem;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        button {
            background: var(--primary-color);
            color: white;
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-right: 0.5rem;
        }

        button:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .remove-btn {
            background-color: var(--danger-color);
            color: white;
            margin-left: auto;
        }
        
        .remove-btn:hover {
            background-color: var(--danger-dark);
        }
        
        .participant-row {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .participant-row input {
            flex-grow: 1;
            margin-bottom: 0;
            margin-right: 1rem;
        }

        .section-card, .custom-section-card {
            background: var(--card-background);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.07);
        }

        .section-wrapper {
            position: relative;
            margin-bottom: 2rem;
        }
        
        .add-between-btn {
            position: absolute;
            left: -60px;
            top: 100%;
            transform: translateY(-50%);
            z-index: 10;
            background: var(--card-background);
            color: var(--primary-color);
            border: 2px solid var(--border-color);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: 300;
            line-height: 1;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 0;
        }
        .add-between-btn:hover {
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-color);
        }
        
        .add-between-btn.minus {
             background-color: var(--danger-color);
             border-color: var(--danger-color);
             color: white;
             font-weight: 400;
        }
        
         .add-between-btn.minus:hover {
             background-color: var(--danger-dark);
             border-color: var(--danger-dark);
        }

        .custom-section-card {
             margin-top: 2rem;
             animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        pre {
            background-color: #fdfdfd;
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            border-radius: 8px;
            white-space: pre-wrap;
            word-wrap: break-word;
            position: relative;
            min-height: 150px;
            line-height: 1.6;
        }

        .copy-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: #27ae60;
        }

        .copy-btn:hover {
            background: #229954;
        }

        /* Photo Report Styles */
        #photo-drop-zone {
            border: 3px dashed var(--border-color);
            border-radius: 12px;
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: var(--card-background);
        }
        #photo-drop-zone.dragover {
            border-color: var(--primary-color);
            background-color: #eff6ff;
        }
        #photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        .photo-card {
            background: var(--card-background);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        .photo-container {
            position: relative;
            width: 100%;
            padding-top: 75%; /* 4:3 Aspect Ratio */
            overflow: hidden;
            background: #eee;
        }
        .photo-card img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
            transition: transform 0.3s ease;
            transform-origin: center;
        }
        .rotate-buttons {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .photo-container:hover .rotate-buttons {
            opacity: 1;
        }
        .rotate-buttons button {
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 1.2rem;
            line-height: 1;
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .photo-card.selected {
            outline: 3px solid var(--primary-color);
            box-shadow: 0 8px 30px rgba(37, 99, 235, 0.4);
        }
        .rotate-buttons button.delete-btn {
            background: var(--danger-color);
        }
        .rotate-buttons button.delete-btn:hover {
            background: var(--danger-dark);
        }
        .photo-card-caption {
            padding: 1rem;
        }
        .photo-card-caption textarea {
            min-height: 60px;
            margin-bottom: 0;
        }
        
        #print-content {
            position: absolute;
            left: -9999px;
            top: -9999px;
        }

        .photo-card img.rotated-grid {
            max-width: 100%;
            max-height: 100%;
            height: auto;
            transform-origin: center;
        }

        @media print {
            @page { 
                size: letter portrait; 
                margin: 0 !important; 
            }
            body * {
                visibility: hidden;
            }
            #print-content, #print-content * {
                visibility: visible;
            }
            #print-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .photo-report-page {
                page-break-after: always;
                width: 100%;
                height: 10in; /* Adjusted for better fit */
                display: flex;
                flex-direction: column;
                justify-content: space-around;
                align-items: center;
                background: white;
                padding: 0.5in;
                box-sizing: border-box;
            }
            /* Single photo per page layout adjustments */
            .photo-report-page.single {
                justify-content: center;
            }
            .photo-report-item {
                width: 100%;
                text-align: center;
                flex: 1; /* Allow items to grow and shrink */
                display: flex;
                flex-direction: column;
                justify-content: flex-start;
                align-items: center;
                /* Allow content to size naturally so captions are not clipped */
            }
            .photo-report-item img {
                max-width: 100%;
                max-height: 4in; /* Leave room for caption */
                object-fit: contain;
                border: 1px solid #ccc;
            }
             .photo-report-item img.rotated-print {
                max-height: 4in; 
                max-width: 4.5in;
            }
            .photo-report-page.single .photo-report-item img {
                max-height: 8in;
                max-width: 100%;
            }
            .photo-report-page.single .photo-report-item img.rotated-print {
                max-height: 8in;
                max-width: 7.5in;
            }
             .photo-report-item p {
                margin-top: 0.25in;
                font-size: 12pt;
            }
        }

    </style>
</head>
<body>
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const App = () => {
            const [activeTab, setActiveTab] = useState('inspection');

            return (
                <div>
                    <h1>Graysons Tools</h1>
                    <div className="tabs">
                        <button className={`tab-button ${activeTab === 'inspection' ? 'active' : ''}`} onClick={() => setActiveTab('inspection')}>
                            Inspection Builder
                        </button>
                        <button className={`tab-button ${activeTab === 'photo' ? 'active' : ''}`} onClick={() => setActiveTab('photo')}>
                            Photo Report
                        </button>
                    </div>

                    <div id="inspection-builder" className={`tab-content ${activeTab === 'inspection' ? 'active' : ''}`}>
                        <InspectionBuilder />
                    </div>
                    <div id="photo-report" className={`tab-content ${activeTab === 'photo' ? 'active' : ''}`}>
                        <PhotoReportBuilder />
                    </div>
                </div>
            );
        }

        const InspectionBuilder = () => {
            const [participants, setParticipants] = useState([{ id: Date.now(), name: 'Insured' }]);
            const [customSections, setCustomSections] = useState([]);
            
            const initialFields = {
                colDetails: '', showCol: false,
                perimeterGeneral: 'No such indicators were observed.', perimeterFront: 'No wind or hail damage observed.', perimeterLeft: 'No wind or hail damage observed.', perimeterRear: 'No wind or hail damage observed.', perimeterRight: 'No wind or hail damage observed.', perimeterEstimate: 'None prepared for no damage', showPerimeter: false,
                roofGeneral: '', roofFrontHits: '0', roofFrontWind: '0', roofRightHits: '0', roofRightWind: '0', roofRearHits: '0', roofRearWind: '0', roofLeftHits: '0', roofLeftWind: '0', roofEstimate: 'No estimate prepared', adjusterName: 'I', showRoof: false,
                otherStructuresDetails: '', showOtherStructures: false,
                rooms: [], interiorEstimate: 'No estimate prepared for interior damages.',
                subroDetails: 'No subro potential', showSubro: true,
                salvageDetails: 'No salvage potential', showSalvage: true,
                underwritingConcernsDetails: 'No underwriting concerns were noted during my inspection', showUnderwriting: true,
                settledOnSite: 'No', settlementDetails: 'Estimate prepared on site, went over estimate, RD, supplement process. Advised of 2 years to complete repairs', paymentType: 'Check', sipIncluded: 'no'
            };
            
            const [fields, setFields] = useState(initialFields);
            const [generatedNote, setGeneratedNote] = useState('');
            
            const mainSectionOrder = ['general', 'col', 'perimeter', 'roof', 'otherStructures', 'interior', 'subro', 'salvage', 'underwriting', 'settlement', 'finalNote'];

            // --- Handlers ---
            const handleFieldChange = (field, value) => {
                setFields(prev => ({ ...prev, [field]: value }));
            };

            const addParticipant = () => setParticipants(prev => [...prev, { id: Date.now(), name: '' }]);
            const updateParticipant = (id, name) => setParticipants(prev => prev.map(p => (p.id === id ? { ...p, name } : p)));
            const removeParticipant = id => setParticipants(prev => prev.filter(p => p.id !== id));

            const addRoom = () => handleFieldChange('rooms', [...fields.rooms, { id: Date.now(), name: '', description: '' }]);
            const updateRoom = (id, field, value) => handleFieldChange('rooms', fields.rooms.map(room => (room.id === id ? { ...room, [field]: value } : room)));
            const removeRoom = id => handleFieldChange('rooms', fields.rooms.filter(room => room.id !== id));
            
            const toggleCustomSection = (sectionId) => {
                const existing = customSections.find(s => s.insertAfterId === sectionId);
                if (existing) {
                    setCustomSections(prev => prev.filter(s => s.insertAfterId !== sectionId));
                } else {
                    const newSection = { id: Date.now(), content: '', insertAfterId: sectionId };
                    setCustomSections(prev => [...prev, newSection]);
                }
            };

            const updateCustomSection = (id, content) => {
                setCustomSections(prev => prev.map(sec => (sec.id === id ? { ...sec, content } : sec)));
            };
            
            // --- Helper Functions ---
            const formatParticipantList = (participantArray) => {
                const names = participantArray.map(p => p.name).filter(Boolean);
                if (names.length === 0) return 'no one';
                if (names.length === 1) return names[0];
                if (names.length === 2) return names.join(' and ');
                const allButLast = names.slice(0, -1).join(', ');
                const lastName = names[names.length - 1];
                return `${allButLast}, and ${lastName}`;
            };
            
            // --- Note Generation ---
            useEffect(() => {
                let note = `Inspected loss. I arrived on time and met with ${formatParticipantList(participants)}.`;
                
                const appendCustomSectionsFor = (sectionId) => {
                    customSections.filter(s => s.insertAfterId === sectionId).forEach(s => {
                        if(s.content) note += `\n\n${s.content}`;
                    });
                };
                
                 mainSectionOrder.forEach(sectionId => {
                    if (sectionId === 'general') {
                         appendCustomSectionsFor('general');
                    } else if (sectionId === 'perimeter' && fields.showPerimeter) {
                        note += `\n\nThe inspection revealed the following:`;
                    }
                    
                    switch (sectionId) {
                        case 'col': if (fields.showCol && fields.colDetails) note += `\n\nCOL: ${fields.colDetails}`; break;
                        case 'perimeter':
                             if (fields.showPerimeter) {
                                note += `\n\nPerimeter:\nAn inspection of the perimeter was performed to verify the presence of storm damage. ${fields.perimeterGeneral}`;
                                note += `\nFront: ${fields.perimeterFront}\nLeft: ${fields.perimeterLeft}\nRear: ${fields.perimeterRear}\nRight: ${fields.perimeterRight}\nEstimate: ${fields.perimeterEstimate}`;
                            } break;
                         case 'roof':
                            if (fields.showRoof) {
                                note += `\n\n${fields.adjusterName} Inspected the roof, which revealed the following:\n${fields.roofGeneral}`;
                                note += `\nFront Facing Slope(s): ${fields.roofFrontHits} hits per test square; ${fields.roofFrontWind} wind damaged shingles`;
                                note += `\nRight Facing Slope(s): ${fields.roofRightHits} hits per test square; ${fields.roofRightWind} wind damaged shingles`;
                                note += `\nRear Facing Slope(s): ${fields.roofRearHits} hits per test square; ${fields.roofRearWind} wind damaged shingles`;
                                note += `\nLeft Facing Slope(s): ${fields.roofLeftHits} hits per test square; ${fields.roofLeftWind} wind damaged shingles`;
                                note += `\nEstimate: ${fields.roofEstimate}`;
                            } break;
                        case 'otherStructures': if (fields.showOtherStructures && fields.otherStructuresDetails) note += `\n\nOther Structures:\n${fields.otherStructuresDetails}`; break;
                        case 'interior':
                            if (fields.rooms.length > 0) {
                                note += `\n\nInterior damages:`;
                                fields.rooms.forEach(room => { if (room.name && room.description) note += `\n\n${room.name}: ${room.description}`; });
                                note += `\nEstimate: ${fields.interiorEstimate}`;
                            } else { note += `\n\nInterior:\nAn inspection of the interior was not performed.`; }
                            break;
                        case 'subro': if (fields.showSubro) note += `\n\nSubro:\n${fields.subroDetails}`; break;
                        case 'salvage': if (fields.showSalvage) note += `\n\nSalvage:\n${fields.salvageDetails}`; break;
                        case 'underwriting': if (fields.showUnderwriting) note += `\n\nUnderwriting concerns:\n${fields.underwritingConcernsDetails}`; break;
                        case 'settlement':
                            note += `\n\nSettlement: ${fields.settlementDetails}`;
                            if (fields.settledOnSite === 'Yes') { note += `\nPayment type: ${fields.paymentType}\nSIP Included: ${fields.sipIncluded}`; }
                            break;
                    }
                    if(sectionId !== 'general') appendCustomSectionsFor(sectionId);
                });

                setGeneratedNote(note);
            }, [fields, participants, customSections]);
            
            const copyToClipboard = () => navigator.clipboard.writeText(generatedNote);

            // --- Render Logic ---
            const componentMap = {
                general: <Section title="General Inspection Details">
                    <label>Met with:</label>
                    {participants.map((p) => (
                        <div key={p.id} className="participant-row">
                            <input type="text" value={p.name} onChange={(e) => updateParticipant(p.id, e.target.value)} placeholder="Participant name..."/>
                            {participants.length > 1 && <button className="remove-btn" onClick={() => removeParticipant(p.id)}>X</button>}
                        </div>
                    ))}
                    <button onClick={addParticipant}>+ Add Participant</button>
                </Section>,
                col: <SectionToggle title="COL Section" show={fields.showCol} onToggle={() => handleFieldChange('showCol', !fields.showCol)}>
                    <textarea value={fields.colDetails} onChange={(e) => handleFieldChange('colDetails', e.target.value)} placeholder="Enter COL details..."></textarea>
                </SectionToggle>,
                 perimeter: <SectionToggle title="Perimeter Inspection" show={fields.showPerimeter} onToggle={() => handleFieldChange('showPerimeter', !fields.showPerimeter)}>
                    <label>General Observation:</label><input type="text" value={fields.perimeterGeneral} onChange={e => handleFieldChange('perimeterGeneral', e.target.value)} />
                    <label>Front:</label><input type="text" value={fields.perimeterFront} onChange={e => handleFieldChange('perimeterFront', e.target.value)} />
                    <label>Left:</label><input type="text" value={fields.perimeterLeft} onChange={e => handleFieldChange('perimeterLeft', e.target.value)} />
                    <label>Rear:</label><input type="text" value={fields.perimeterRear} onChange={e => handleFieldChange('perimeterRear', e.target.value)} />
                    <label>Right:</label><input type="text" value={fields.perimeterRight} onChange={e => handleFieldChange('perimeterRight', e.target.value)} />
                    <label>Estimate:</label><input type="text" value={fields.perimeterEstimate} onChange={e => handleFieldChange('perimeterEstimate', e.target.value)} />
                </SectionToggle>,
                roof: <SectionToggle title="Roof Inspection" show={fields.showRoof} onToggle={() => handleFieldChange('showRoof', !fields.showRoof)}>
                    <label>Adjuster Name:</label><select value={fields.adjusterName} onChange={e => handleFieldChange('adjusterName', e.target.value)}><option value="I">I</option><option value="Seeknow">Seeknow</option></select>
                    <label>General Observations:</label><textarea value={fields.roofGeneral} onChange={e => handleFieldChange('roofGeneral', e.target.value)} placeholder="e.g., No wind or hail damage..."></textarea>
                    <label>Front Slope Hits/Wind:</label><div style={{display:'flex', gap:'1rem'}}><input type="text" value={fields.roofFrontHits} onChange={e => handleFieldChange('roofFrontHits', e.target.value)} /><input type="text" value={fields.roofFrontWind} onChange={e => handleFieldChange('roofFrontWind', e.target.value)} /></div>
                    <label>Right Slope Hits/Wind:</label><div style={{display:'flex', gap:'1rem'}}><input type="text" value={fields.roofRightHits} onChange={e => handleFieldChange('roofRightHits', e.target.value)} /><input type="text" value={fields.roofRightWind} onChange={e => handleFieldChange('roofRightWind', e.target.value)} /></div>
                    <label>Rear Slope Hits/Wind:</label><div style={{display:'flex', gap:'1rem'}}><input type="text" value={fields.roofRearHits} onChange={e => handleFieldChange('roofRearHits', e.target.value)} /><input type="text" value={fields.roofRearWind} onChange={e => handleFieldChange('roofRearWind', e.target.value)} /></div>
                    <label>Left Slope Hits/Wind:</label><div style={{display:'flex', gap:'1rem'}}><input type="text" value={fields.roofLeftHits} onChange={e => handleFieldChange('roofLeftHits', e.target.value)} /><input type="text" value={fields.roofLeftWind} onChange={e => handleFieldChange('roofLeftWind', e.target.value)} /></div>
                    <label>Estimate:</label><input type="text" value={fields.roofEstimate} onChange={e => handleFieldChange('roofEstimate', e.target.value)} />
                </SectionToggle>,
                otherStructures: <SectionToggle title="Other Structures" show={fields.showOtherStructures} onToggle={() => handleFieldChange('showOtherStructures', !fields.showOtherStructures)}>
                     <textarea value={fields.otherStructuresDetails} onChange={e => handleFieldChange('otherStructuresDetails', e.target.value)} placeholder="Enter details..."></textarea>
                </SectionToggle>,
                interior: <Section title="Interior Damages">
                    {fields.rooms.map((room, index) => (
                        <div key={room.id}><label>Room {index + 1}:</label><div className="participant-row"><input type="text" value={room.name} onChange={e => updateRoom(room.id, 'name', e.target.value)} placeholder="e.g., Kitchen" /><button className="remove-btn" onClick={() => removeRoom(room.id)}>X</button></div><label>Description:</label><textarea value={room.description} onChange={e => updateRoom(room.id, 'description', e.target.value)} placeholder="e.g., Water stain..."></textarea></div>
                    ))}<button onClick={addRoom}>+ Add Room</button>
                    {fields.rooms.length > 0 && <div style={{marginTop:'1.5rem'}}><label>Overall Estimate:</label><textarea value={fields.interiorEstimate} onChange={e => handleFieldChange('interiorEstimate', e.target.value)}></textarea></div>}
                </Section>,
                subro: <SectionToggle title="Subrogation" show={fields.showSubro} onToggle={() => handleFieldChange('showSubro', !fields.showSubro)}><textarea value={fields.subroDetails} onChange={e => handleFieldChange('subroDetails', e.target.value)}></textarea></SectionToggle>,
                salvage: <SectionToggle title="Salvage" show={fields.showSalvage} onToggle={() => handleFieldChange('showSalvage', !fields.showSalvage)}><textarea value={fields.salvageDetails} onChange={e => handleFieldChange('salvageDetails', e.target.value)}></textarea></SectionToggle>,
                underwriting: <SectionToggle title="Underwriting Concerns" show={fields.showUnderwriting} onToggle={() => handleFieldChange('showUnderwriting', !fields.showUnderwriting)}><textarea value={fields.underwritingConcernsDetails} onChange={e => handleFieldChange('underwritingConcernsDetails', e.target.value)}></textarea></SectionToggle>,
                settlement: <Section title="Settlement">
                    <label>Settlement Details:</label><textarea value={fields.settlementDetails} onChange={e => handleFieldChange('settlementDetails', e.target.value)}></textarea>
                    <label>Settled on Site?</label><select value={fields.settledOnSite} onChange={e => handleFieldChange('settledOnSite', e.target.value)}><option value="No">No</option><option value="Yes">Yes</option></select>
                    {fields.settledOnSite === 'Yes' && (<><label>Payment type:</label><select value={fields.paymentType} onChange={e => handleFieldChange('paymentType', e.target.value)}><option value="Check">Check</option><option value="Manual Check">Manual Check</option><option value="EFT">EFT</option></select><label>SIP Included:</label><select value={fields.sipIncluded} onChange={e => handleFieldChange('sipIncluded', e.target.value)}><option value="yes">Yes</option><option value="no">No</option></select></>)}
                </Section>,
                finalNote: <Section title="Generated Inspection Note">
                    <pre>{generatedNote}</pre>
                    <button className="copy-btn" onClick={copyToClipboard}>Copy Note</button>
                </Section>,
            };
            
            return (
                <div>
                    {mainSectionOrder.map(sectionId => {
                        const customSection = customSections.find(s => s.insertAfterId === sectionId);
                        const hasCustomSection = !!customSection;

                        return (
                            <React.Fragment key={sectionId}>
                                <div className="section-wrapper" style={{'padding-left': '80px'}}>
                                    <div className="section-card">{componentMap[sectionId]}</div>
                                    {sectionId !== 'finalNote' && (
                                        <button 
                                            className={`add-between-btn ${hasCustomSection ? 'minus' : ''}`} 
                                            onClick={() => toggleCustomSection(sectionId)}
                                        >
                                            {hasCustomSection ? '−' : '+'}
                                        </button>
                                    )}
                                </div>
                                {hasCustomSection && (
                                    <div className="custom-section-card" style={{'margin-left': '80px'}}>
                                        <h4>Custom Note</h4>
                                        <textarea value={customSection.content} onChange={e => updateCustomSection(customSection.id, e.target.value)} placeholder="Enter custom notes here..."/>
                                    </div>
                                )}
                            </React.Fragment>
                        );
                    })}
                </div>
            );
        }
        
        const PhotoReportBuilder = () => {
            const [photos, setPhotos] = useState([]);
            const [selectedPhotos, setSelectedPhotos] = useState(new Set());
            const dropZoneRef = useRef(null);
            const fileInputRef = useRef(null);
            const lastSelectedId = useRef(null);
            const [photosPerPage, setPhotosPerPage] = useState(2);
            const [compression, setCompression] = useState('regular');

            const handleFileChange = (e) => {
                const files = Array.from(e.target.files);
                processFiles(files);
            };

            const processFiles = (files) => {
                const imageFiles = files.filter(file => file.type.startsWith('image/'));
                const newPhotos = imageFiles.map(file => ({
                    id: Date.now() + Math.random(),
                    src: URL.createObjectURL(file),
                    caption: '',
                    rotation: 0,
                    file: file
                }));
                setPhotos(prev => [...prev, ...newPhotos]);
            };
            
            const updateCaption = (id, caption) => {
                setPhotos(prev => prev.map(p => p.id === id ? {...p, caption} : p));
            };

            const handleCaptionKeyDown = (e, id) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const caption = e.target.value;
                    if (selectedPhotos.has(id)) {
                        // Apply to all selected
                        setPhotos(prev => prev.map(p => selectedPhotos.has(p.id) ? { ...p, caption } : p));
                    } else {
                        // Apply to just this one
                        updateCaption(id, caption);
                    }
                }
            };

            const rotatePhoto = (id, direction) => {
                setPhotos(prev => prev.map(p => {
                    if (p.id === id) {
                        const newRotation = p.rotation + (direction === 'left' ? -90 : 90);
                        return { ...p, rotation: newRotation };
                    }
                    return p;
                }));
            };

            const removePhoto = (id) => {
                setPhotos(prev => prev.filter(p => p.id !== id));
                setSelectedPhotos(prev => {
                    const newSelection = new Set(prev);
                    newSelection.delete(id);
                    return newSelection;
                });
            };

            const handlePhotoClick = (e, id) => {
                const newSelection = new Set(selectedPhotos);
                if (e.shiftKey && lastSelectedId.current) {
                    const lastIndex = photos.findIndex(p => p.id === lastSelectedId.current);
                    const currentIndex = photos.findIndex(p => p.id === id);
                    const start = Math.min(lastIndex, currentIndex);
                    const end = Math.max(lastIndex, currentIndex);
                    for (let i = start; i <= end; i++) {
                        newSelection.add(photos[i].id);
                    }
                } else if (e.ctrlKey) {
                    if (newSelection.has(id)) {
                        newSelection.delete(id);
                    } else {
                        newSelection.add(id);
                    }
                } else {
                    newSelection.clear();
                    newSelection.add(id);
                }
                setSelectedPhotos(newSelection);
                lastSelectedId.current = id;
            };

            const handleDrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZoneRef.current.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                processFiles(files);
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZoneRef.current.classList.add('dragover');
            };

            const handleDragLeave = (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZoneRef.current.classList.remove('dragover');
            };
            
            const generatePdf = async () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ unit: 'in', format: 'letter', orientation: 'portrait' });
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 0.5;
                const contentWidth = pageWidth - margin * 2;
                const contentHeight = pageHeight - margin * 2;

                const settingsMap = {
                    regular: { dpi: 144, quality: 0.92 },
                    smaller: { dpi: 120, quality: 0.82 },
                    smallest: { dpi: 96, quality: 0.72 },
                };
                const { dpi, quality } = settingsMap[compression] || settingsMap.regular;

                const loadImage = (src) => new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => resolve(img);
                    img.onerror = reject;
                    img.src = src;
                });

                const drawPhoto = async (photo, xIn, yIn, maxWidthIn, maxImageHeightIn) => {
                    const img = await loadImage(photo.src);
                    const rotation = ((photo.rotation || 0) % 360 + 360) % 360;
                    const rotated = rotation % 180 !== 0;

                    const originalWidth = img.naturalWidth || img.width;
                    const originalHeight = img.naturalHeight || img.height;
                    const orientedWidth = rotated ? originalHeight : originalWidth;
                    const orientedHeight = rotated ? originalWidth : originalHeight;
                    const aspect = orientedWidth / orientedHeight;

                    let targetWidthIn = Math.min(maxWidthIn, maxImageHeightIn * aspect);
                    let targetHeightIn = targetWidthIn / aspect;
                    if (targetHeightIn > maxImageHeightIn) {
                        targetHeightIn = maxImageHeightIn;
                        targetWidthIn = targetHeightIn * aspect;
                    }

                    const targetWidthPx = Math.max(1, Math.round(targetWidthIn * dpi));
                    const targetHeightPx = Math.max(1, Math.round(targetHeightIn * dpi));

                    const canvas = document.createElement('canvas');
                    // If rotating 90/270 deg, the drawing box swaps
                    canvas.width = rotated ? targetHeightPx : targetWidthPx;
                    canvas.height = rotated ? targetWidthPx : targetHeightPx;
                    const ctx = canvas.getContext('2d');
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    ctx.save();
                    ctx.translate(canvas.width / 2, canvas.height / 2);
                    if (rotation !== 0) {
                        ctx.rotate((rotation * Math.PI) / 180);
                    }
                    const drawWidthPx = rotated ? targetWidthPx : targetWidthPx;
                    const drawHeightPx = rotated ? targetHeightPx : targetHeightPx;
                    ctx.drawImage(img, -drawWidthPx / 2, -drawHeightPx / 2, drawWidthPx, drawHeightPx);
                    ctx.restore();

                    const dataUrl = canvas.toDataURL('image/jpeg', quality);
                    const offsetXIn = xIn + (maxWidthIn - targetWidthIn) / 2;
                    doc.addImage(dataUrl, 'JPEG', offsetXIn, yIn, targetWidthIn, targetHeightIn, undefined, 'FAST');
                    return { imageHeightIn: targetHeightIn };
                };

                let index = 0;
                let isFirstPage = true;
                while (index < photos.length) {
                    if (!isFirstPage) doc.addPage();
                    isFirstPage = false;

                    if (photosPerPage === 2) {
                        const slotHeightIn = contentHeight / 2;
                        const imageMaxHeightIn = slotHeightIn - 0.7;
                        let yIn = margin;
                        for (let slot = 0; slot < 2 && index < photos.length; slot++) {
                            const { imageHeightIn } = await drawPhoto(photos[index], margin, yIn, contentWidth, imageMaxHeightIn);
                            const caption = photos[index].caption || '';
                            const captionY = yIn + imageHeightIn + 0.2;
                            const lines = doc.splitTextToSize(caption, contentWidth);
                            doc.setFontSize(12);
                            doc.text(lines, margin, captionY, { maxWidth: contentWidth });
                            index++;
                            yIn += slotHeightIn;
                        }
                    } else {
                        const imageMaxHeightIn = contentHeight - 1.0;
                        const { imageHeightIn } = await drawPhoto(photos[index], margin, margin, contentWidth, imageMaxHeightIn);
                        const caption = photos[index].caption || '';
                        const captionY = margin + imageHeightIn + 0.3;
                        const lines = doc.splitTextToSize(caption, contentWidth);
                        doc.setFontSize(12);
                        doc.text(lines, margin, captionY, { maxWidth: contentWidth });
                        index++;
                    }
                }

                doc.save('PhotoReport.pdf');
            };

            return (
                <div>
                    <div id="photo-controls" className="section-card no-print">
                        <h2>Photo Report Builder</h2>
                        <input type="file" multiple accept="image/*" onChange={handleFileChange} style={{ display: 'none' }} ref={fileInputRef} />
                        <div 
                            id="photo-drop-zone" 
                            ref={dropZoneRef}
                            onClick={() => fileInputRef.current.click()}
                            onDrop={handleDrop}
                            onDragOver={handleDragOver}
                            onDragLeave={handleDragLeave}
                        >
                            <p>Drag & drop photos here, or click to select files.</p>
                        </div>
                        <div style={{ display: 'flex', gap: '2rem', marginTop: '1rem', flexWrap: 'wrap' }}>
                            <div>
                                <label style={{ fontWeight: 600 }}>Photos per page</label>
                                <div style={{ display: 'flex', gap: '1rem', marginTop: '0.5rem' }}>
                                    <label><input type="radio" name="ppp" value="2" checked={photosPerPage === 2} onChange={() => setPhotosPerPage(2)} /> 2 per page</label>
                                    <label><input type="radio" name="ppp" value="1" checked={photosPerPage === 1} onChange={() => setPhotosPerPage(1)} /> 1 per page</label>
                                </div>
                            </div>
                            <div>
                                <label style={{ fontWeight: 600 }}>PDF/Photo compression</label>
                                <div style={{ display: 'flex', gap: '1rem', marginTop: '0.5rem', flexWrap: 'wrap' }}>
                                    <label><input type="radio" name="compression" value="regular" checked={compression === 'regular'} onChange={() => setCompression('regular')} /> Regular</label>
                                    <label><input type="radio" name="compression" value="smaller" checked={compression === 'smaller'} onChange={() => setCompression('smaller')} /> Smaller</label>
                                    <label><input type="radio" name="compression" value="smallest" checked={compression === 'smallest'} onChange={() => setCompression('smallest')} /> Smallest</label>
                                </div>
                            </div>
                        </div>
                        <div style={{marginTop: '1rem', display: 'flex', gap: '0.5rem', flexWrap: 'wrap'}}>
                            <button onClick={generatePdf} disabled={photos.length === 0}>Generate PDF</button>
                            <button onClick={() => window.print()} disabled={photos.length === 0}>Print Preview</button>
                        </div>
                    </div>

                    <div id="photo-grid" className="no-print">
                        {photos.map(photo => (
                            <div 
                                key={photo.id} 
                                className={`photo-card ${selectedPhotos.has(photo.id) ? 'selected' : ''}`}
                                onClick={(e) => handlePhotoClick(e, photo.id)}
                            >
                                <div className="photo-container">
                                    <img 
                                        src={photo.src} 
                                        className={photo.rotation % 180 !== 0 ? 'rotated-grid' : ''}
                                        style={{ transform: `rotate(${photo.rotation}deg)` }} 
                                    />
                                    <div className="rotate-buttons">
                                        <button onClick={(e) => {e.stopPropagation(); removePhoto(photo.id);}}>X</button>
                                        <button onClick={(e) => {e.stopPropagation(); rotatePhoto(photo.id, 'left');}}>↺</button>
                                        <button onClick={(e) => {e.stopPropagation(); rotatePhoto(photo.id, 'right');}}>↻</button>
                                    </div>
                                </div>
                                <div className="photo-card-caption">
                                    <textarea 
                                        value={photo.caption} 
                                        onChange={(e) => updateCaption(photo.id, e.target.value)}
                                        onKeyDown={(e) => handleCaptionKeyDown(e, photo.id)}
                                        placeholder="Enter caption..."
                                        onClick={(e) => e.stopPropagation()} // Prevent card selection when clicking textarea
                                    />
                                </div>
                            </div>
                        ))}
                    </div>
                    
                    <div id="print-content">
                        {photosPerPage === 2 ? (
                            photos.map((photo, index) => (
                                (index % 2 === 0) && (
                                    <div className="photo-report-page" key={`page-${index}`}>
                                        <div className="photo-report-item">
                                            <img 
                                                src={photos[index].src} 
                                                className={photos[index].rotation % 180 !== 0 ? 'rotated-print' : ''}
                                                style={{ transform: `rotate(${photos[index].rotation}deg)` }} 
                                            />
                                            <p>{photos[index].caption}</p>
                                        </div>
                                        {photos[index + 1] && (
                                            <div className="photo-report-item">
                                                <img 
                                                    src={photos[index + 1].src} 
                                                    className={photos[index + 1].rotation % 180 !== 0 ? 'rotated-print' : ''}
                                                    style={{ transform: `rotate(${photos[index + 1].rotation}deg)` }} 
                                                />
                                                <p>{photos[index + 1].caption}</p>
                                            </div>
                                        )}
                                    </div>
                                )
                            ))
                        ) : (
                            photos.map((p, i) => (
                                <div className="photo-report-page single" key={`page-single-${i}`}>
                                    <div className="photo-report-item">
                                        <img 
                                            src={p.src} 
                                            className={p.rotation % 180 !== 0 ? 'rotated-print' : ''}
                                            style={{ transform: `rotate(${p.rotation}deg)` }} 
                                        />
                                        <p>{p.caption}</p>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>
                </div>
            );
        };

        const Section = ({ title, children }) => (
            <>
                <h2>{title}</h2>
                <div style={{paddingTop: '1rem'}}>{children}</div>
            </>
        );

        const SectionToggle = ({ title, show, onToggle, children }) => (
            <>
                <h2 onClick={onToggle} style={{ cursor: 'pointer' }}>
                    {title} 
                    <span style={{marginLeft: 'auto', fontSize:'1.5rem', fontWeight: 400, color: 'var(--primary-color)'}}>{show ? '−' : '+'}</span>
                </h2>
                {show && <div style={{paddingTop: '1rem', animation: 'fadeIn 0.5s ease'}}>{children}</div>}
            </>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
